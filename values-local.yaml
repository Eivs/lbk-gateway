
metallb:
  enabled: true
  crds:
    enabled: true  # MetalLB CRD 需要由 Helm 安装
    validationFailurePolicy: Ignore  # webhook 未就绪时不阻止资源创建

  # Controller
  controller:
    enabled: true
    image:
      repository: "dockerhub.kubekey.local/qce/metallb/controller"
      tag: v0.15.3
    nodeSelector:
      node-role.qingcloud.com/control-plane: ""

  # Speaker
  speaker:
    enabled: true
    image:
      repository: "dockerhub.kubekey.local/qce/metallb/speaker"
      tag: v0.15.3
    nodeSelector:
      node-role.qingcloud.com/control-plane: ""

    # FRR 镜像（BGP 模式需要）
    frr:
      enabled: false
      image:
        repository: "dockerhub.kubekey.local/qce/metallb/frrouting/frr"
        tag: 10.4.1


  ipAddressPools:
    - name: default-pool
      protocol: layer2
      addresses:
        - 172.31.59.200-172.31.59.220
      autoAssign: true

  # L2 广播配置
  l2Advertisements:
    - name: default-advertisement
      ipAddressPools:
      - default-pool  # 对应 IP 池名称
      interfaces:
      - eth0   # IP 池使用的网口


envoyGateway:
  enabled: true

  # ==========================================
  # 镜像配置
  # ==========================================
  global:
    imageRegistry: ""
    imagePullSecrets: []

    images:
      envoyGateway:
        image: "dockerhub.kubekey.local/qce/envoyproxy/gateway-dev:latest"
        pullPolicy: IfNotPresent
        pullSecrets: []
      ratelimit:
        image: "dockerhub.kubekey.local/qce/envoyproxy/ratelimit:master"
        pullPolicy: IfNotPresent
        pullSecrets: []
      envoyProxy:
        image: "dockerhub.kubekey.local/qce/envoyproxy/envoy:distroless-dev"
        pullPolicy: IfNotPresent
        pullSecrets: []

  deployment:
    pod:
      tolerations: []
      nodeSelector:
        node-role.qingcloud.com/control-plane: ""


  certgen:
    job:
      args:
      - --disable-topology-injector

# ==========================================
# Whoami 示例应用（用于验证）
# ==========================================
whoami:
  enabled: true  # 设置为 true 启用示例应用

  image:
    registry: "dockerhub.kubekey.local"
    repository: "qce/traefik/whoami"
    tag: latest
    pullPolicy: IfNotPresent

  # Service 配置
  service:
    type: LoadBalancer  # 使用 LoadBalancer 测试 MetalLB
    port: 80
    targetPort: 80

  # Deployment 配置
  deployment:
    replicas: 2
    resources:
      requests:
        cpu: "10m"
        memory: "20Mi"
      limits:
        cpu: "100m"
        memory: "50Mi"

  # Gateway API 配置
  gateway:
    enabled: true  # 创建 Gateway 和 HTTPRoute
    host: "whoami.local"  # 示例主机名


# ==========================================
# 常见配置示例（取消注释使用）
# ==========================================

# 离线安装配置
# global:
#   imageRegistry: "harbor.example.com"
#   imagePullSecrets:
#     - name: regcred

# 使用 BGP 模式
# metallb:
#   ipAddressPools:
#     - name: bgp-pool
#       protocol: bgp
#       addresses:
#         - 10.0.100.0-10.0.100.255
#   bgp:
#     peers:
#       - my-asn: 64500
#         peer-asn: 64501
#         peer-address: 192.168.1.1
#         source-address: 192.168.1.2

# 启用 Prometheus 监控
# metallb:
#   prometheus:
#     serviceMonitor:
#       enabled: true

# Envoy Gateway 会自动暴露 metrics 端口 19001，可以使用 ServiceMonitor 收集

# 配置 HTTPS/TLS
# 在 Gateway 资源中配置证书引用:
#
# apiVersion: gateway.networking.k8s.io/v1
# kind: Gateway
# metadata:
#   name: example-gateway
# spec:
#   gatewayClassName: eg
#   listeners:
#     - name: https
#       protocol: HTTPS
#       port: 443
#       hostname: example.com
#       tls:
#         mode: Terminate
#         certificateRefs:
#           - kind: Secret
#             name: example-tls-cert
