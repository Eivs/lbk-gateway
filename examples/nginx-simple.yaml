# ==========================================
# Nginx 简单示例 - 通过 LBK Gateway 暴露服务
# ==========================================
# 此示例演示如何快速创建一个 Nginx 应用，并通过 Gateway API 暴露
#
# 应用步骤：
#   1. kubectl apply -f examples/nginx-simple.yaml
#   2. 获取 External IP: kubectl get svc nginx -n lbk-system
#   3. 访问: curl http://<EXTERNAL_IP>/
#
# ==========================================


---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: nginx
  labels:
    app: nginx
    part-of: nginx-example
spec:
  replicas: 2
  selector:
    matchLabels:
      app: nginx
  template:
    metadata:
      labels:
        app: nginx
        part-of: nginx-example
    spec:
      containers:
      - name: nginx
        image: nginx:latest
        imagePullPolicy: IfNotPresent
        ports:
        - name: http
          containerPort: 80
          protocol: TCP

---
apiVersion: v1
kind: Service
metadata:
  name: nginx
  labels:
    app: nginx
    part-of: nginx-example
spec:
  type: ClusterIP
  selector:
    app: nginx
  ports:
  - name: http
    port: 80
    targetPort: 80
    protocol: TCP

---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: nginx
  labels:
    app: nginx
    app.kubernetes.io/part-of: envoy-gateway
spec:
  parentRefs:
  # 关联到 Envoy Gateway 创建的 Gateway
  - name: eg
  hostnames:
  - "nginx.local"  # 可选：指定主机名
  rules:
  - backendRefs:
    - name: nginx
      port: 80
    matches:
    - path:
        type: PathPrefix
        value: /

---
# 可选：创建自定义 Gateway（如果需要独立的 Gateway）
# apiVersion: gateway.networking.k8s.io/v1
# kind: Gateway
# metadata:
#   name: nginx-gateway
#   labels:
#     app: nginx
#     app.kubernetes.io/part-of: lbk-gateway
# spec:
#   gatewayClassName: eg
#   listeners:
#   - name: http
#     protocol: HTTP
#     port: 80
#     hostname: nginx.local

# ==========================================
# 验证步骤
# ==========================================
#   kubectl appl
# 1. 等待 Pod 启动
#    kubectl wait --for=condition=ready pod -l app=nginx -n nginx-example --timeout=60s
#
# 2. 方式 1: 通过 LoadBalancer Service 访问
#    kubectl get svc nginx-lb -n nginx-example
#    export NGINX_LB_IP=$(kubectl get svc nginx-lb -n nginx-example -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
#    curl http://${NGINX_LB_IP}/
#
# 3. 方式 2: 通过 Gateway API 访问
#    # 获取 Envoy Gateway 的 External IP
#    export GATEWAY_IP=$(kubectl get svc envoy-gateway -n envoy-gateway-system -o jsonpath='{.status.loadBalancer.ingress[0].ip}')
#
#    # 通过 IP + Host header 访问
#    curl -H "Host: nginx.example.com" http://${GATEWAY_IP}/
#
#    # 或者添加本地 hosts 记录
#    echo "${GATEWAY_IP} nginx.example.com" | sudo tee -a /etc/hosts
#    curl http://nginx.example.com/
#
# 4. 查看日志
#    kubectl logs -l app=nginx -n nginx-example --tail=20 -f
#
# 5. 清理资源
#    kubectl delete namespace nginx-example
#
# ==========================================
