# ==========================================
# Metal Gateway - LoadBalancer Kit Gateway 离线安装配置
# ==========================================
# 本 chart 使用官方 MetalLB 和 Envoy Gateway charts 作为依赖
# ==========================================


# ==========================================
# MetalLB 配置
# ==========================================
metallb:
  enabled: true
  nameOverride: "metallb"
  fullnameOverride: "metallb"
  # 支持: layer2 (L2模式) 或 bgp (BGP模式)
  mode: layer2

  crds:
    enabled: true  # MetalLB CRD 需要由 Helm 安装
    validationFailurePolicy: Ignore  # webhook 未就绪时不阻止资源创建

  # ==========================================
  # MetalLB 镜像配置
  # ==========================================
  # Controller 镜像
  controller:
    enabled: true
    image:
      repository: quay.io/metallb/controller
      tag: v0.15.3
    tolerations: []
    nodeSelector:
      node-role.kubernetes.io/control-plane: ""
    priorityClassName: system-cluster-critical
    resources:
      requests:
        cpu: 10m
        memory: 50Mi
      limits:
        cpu: 100m
        memory: 100Mi

  # Speaker 镜像
  speaker:
    enabled: true
    tolerations: []
    nodeSelector: {}
    image:
      repository: quay.io/metallb/speaker
      tag: v0.15.3
    tolerateMaster: false
    priorityClassName: system-node-critical
    resources:
      requests:
        cpu: 50m
        memory: 100Mi
      limits:
        cpu: 200m
        memory: 300Mi

    # FRR 镜像（BGP 模式需要）
    frr:
      enabled: false
      tolerations: []
      nodeSelector: {}
      image:
        repository: quay.io/frrouting/frr
        tag: 10.4.1
      tolerateMaster: false
      priorityClassName: system-node-critical
      resources:
        requests:
          cpu: 100m
          memory: 200Mi
        limits:
          cpu: 500m
          memory: 500Mi



  # ==========================================
  # MetalLB IP 地址池配置
  # ==========================================
  # 重要：根据你的网络环境修改 addresses
  ipAddressPools:
    - name: default-pool
      protocol: layer2
      addresses:
        - 172.20.88.100-172.20.88.150
      autoAssign: true

  # ==========================================
  # L2 广播配置（仅当 mode: layer2 时生效）
  # ==========================================
  l2Advertisements:
    - name: default-advertisement
      ipAddressPools:
      - default-pool  # 对应 IP 池名称
      interfaces:
      - eth0   # IP 池使用的网口

  # ==========================================
  # BGP 广播配置（仅当 mode: bgp 时生效）
  # ==========================================
  # bgpAdvertisements:
  #   - name: default-bgp-advertisement
  #     ipAddressPools:
  #     - default-pool  # 对应 IP 池名称
      # aggregationLength: 32  # 可选：IP 聚合长度
      # localPref: 100  # 可选：本地优先级

  # Prometheus 监控（可选）
  prometheus:
    serviceMonitor:
      enabled: false
    podMonitor:
      enabled: false
    prometheusRule:
      enabled: false

# ==========================================
# Envoy Gateway 配置
# ==========================================
envoyGateway:
  enabled: true
  nameOverride: ""
  fullnameOverride: envoy-gateway
  # ==========================================
  # 镜像配置
  # ==========================================
  global:
    imageRegistry: ""
    imagePullSecrets: []

    images:
      envoyGateway:
        image: docker.io/envoyproxy/gateway-dev:latest
        pullPolicy: IfNotPresent
        pullSecrets: []
      ratelimit:
        image: docker.io/envoyproxy/ratelimit:master
        pullPolicy: IfNotPresent
        pullSecrets: []
      envoyProxy:
        image: docker.io/envoyproxy/envoy:distroless-dev
        pullPolicy: IfNotPresent
        pullSecrets: []
  # ==========================================
  # 部署配置
  # ==========================================
  deployment:
    replicas: 1
    envoyGateway:
      image:
        repository: ""  # 如果需要覆盖镜像仓库
        tag: ""
      imagePullPolicy: ""
      imagePullSecrets: []
      resources:
        requests:
          cpu: "100m"
          memory: "256Mi"
        limits:
          cpu: "500m"
          memory: "1024Mi"
    pod:
      tolerations: []
      nodeSelector: {}

  # ==========================================
  # Certgen 配置（证书生成）
  # ==========================================
  certgen:
    job:
      args:
      - --disable-topology-injector

  # ==========================================
  # Service 配置
  # ==========================================
  service:
    enabled: true
    type: LoadBalancer
    annotations: {}
    labels: {}

  # ==========================================
  # Envoy Gateway 配置
  # ==========================================
  config:
    envoyGateway:
      gateway:
        controllerName: gateway.envoyproxy.io/gatewayclass-controller
      name: lbk-envoy-gateway
      provider:
        type: Kubernetes
      logging:
        level:
          default: info
    # Envoy Proxy 镜像配置（数据平面）
    envoy:
      image: docker.io/envoyproxy/envoy:distroless-dev

  # ==========================================
  # 自动扩缩配置（可选）
  # ==========================================
  hpa:
    enabled: false
    minReplicas: 1
    maxReplicas: 3


# ==========================================
# Whoami 示例应用（用于验证）
# ==========================================
whoami:
  enabled: false  # 设置为 true 启用示例应用

  image:
    registry: docker.io
    repository: traefik/whoami
    tag: latest
    pullPolicy: IfNotPresent

  # Service 配置
  service:
    type: LoadBalancer  # 使用 LoadBalancer 测试 MetalLB
    port: 80
    targetPort: 80

  # Deployment 配置
  deployment:
    replicas: 2
    resources:
      requests:
        cpu: "10m"
        memory: "20Mi"
      limits:
        cpu: "100m"
        memory: "50Mi"

  # Gateway API 配置
  gateway:
    enabled: true  # 创建 Gateway 和 HTTPRoute
    host: "whoami.local"  # 示例主机名


# ==========================================
# 常见配置示例（取消注释使用）
# ==========================================

# 离线安装配置
# global:
#   imageRegistry: "harbor.example.com"
#   imagePullSecrets:
#     - name: regcred

# 使用 BGP 模式
# metallb:
#   ipAddressPools:
#     - name: bgp-pool
#       protocol: bgp
#       addresses:
#         - 10.0.100.0-10.0.100.255
#   bgp:
#     peers:
#       - my-asn: 64500
#         peer-asn: 64501
#         peer-address: 192.168.1.1
#         source-address: 192.168.1.2

# 启用 Prometheus 监控
# metallb:
#   prometheus:
#     serviceMonitor:
#       enabled: true

# Envoy Gateway 会自动暴露 metrics 端口 19001，可以使用 ServiceMonitor 收集

# 配置 HTTPS/TLS
# 在 Gateway 资源中配置证书引用:
#
# apiVersion: gateway.networking.k8s.io/v1
# kind: Gateway
# metadata:
#   name: example-gateway
# spec:
#   gatewayClassName: eg
#   listeners:
#     - name: https
#       protocol: HTTPS
#       port: 443
#       hostname: example.com
#       tls:
#         mode: Terminate
#         certificateRefs:
#           - kind: Secret
#             name: example-tls-cert
